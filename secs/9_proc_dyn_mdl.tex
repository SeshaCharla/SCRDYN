\newpage
\section{SCR Process Dynamics with Urea Dosing \label{sec::proc_dyn}}
From previous derivations, we have the complete process dynamics of SCR-ASC dynamics with urea dosing as:

\begin{enumerate}
    \item Urea dosing dynamics:
    \begin{align*}
    \con{NH_3}^{in} (k) &= 2r_u V \times \frac{u_{inj}(k)}{f_v^2}
    \end{align*}

    \item $NO_x$ reduction dynamics:
    \begin{align*}
    \con{NO_x}^{out} (k + 1) &= \con{NO_x}^{in} (k) \lr{1 - k_{s2v} k_{scr} \sigma(k) \tau}
    \end{align*}

    \item Gaseous ammonia dynamics:
    \begin{align*}
    \con{NH_3}^{out} (k + 1) &= \con{NH_3}^{in}(k) \lr{1 - \tau k_{s2v}k_{ads} \lr{\Gamma - \sigma(k)}} + \tau k_{s2v} k_{des} \sigma(k)
    \end{align*}

    \item Ammonia adsorption/desorption dynamics:
 \begin{align*}
        \sigma(k + 1) &= \sigma(k)
        + n\tau k_{ads} \con{NH_3}^{in} \lr{\Gamma - \sigma(k)}
        - n \tau \lr{k_{oxi} + k_{des}} \sigma(k)
        - n \tau k_{scr} \con{NO_x}^{in}(k) \sigma(k)
    \end{align*}
\end{enumerate}

The above four equations are the complete process dynamics of SCR-ASC dynamics with urea dosing. The above equations are
nonlinear and coupled with implicit dependence on temperature and flow rate. In this section the above equations are
rewritten in a parametric form with standard state-space representation. For convenience and clarity '(k)' is dropped
from the variables.

\subsection{Linear Parameter Models}
The following states and inputs are defined for the system:

\begin{align*}
    x_1 &= \con{NO_x}^{out} & u_1 &= \con{NO_x}^{in} \\
    x_2 &= \con{NH_3}^{out} & u_2 &= u_{inj} \\
    x_3 &= \sigma & u_3 &= T\\
        &         & u_4 &= F
\end{align*}

Thus, linear-parameter representation of each of the processes are as follows:

\input{secs/9_subs/urea_dosing.tex}
\input{secs/9_subs/nox_proc.tex}
\input{secs/9_subs/nh3_gas.tex}
\input{secs/9_subs/nh3_ads.tex}
% ==============================================================================
\subsection{SCR-ASC Process Dynamics in Parametric Model Identification}
\begin{align*}
    x_1(k+1) &= u_1 - \pmb \phi_1^T \lr{x_3 \pmb \theta_1}\\
    x_2(k+1) &= \pmb \phi_2^T \pmb \theta_2\\
    x_3(k+1) &= x_3 - \pmb \phi_3^T \pmb \theta_3\\
    \text{where:} \qquad &\\
    \pmb \phi_1 &= u_1 \pmb \phi_0\\
    \pmb \phi_2 &= \bm{\frac{u_2}{(u_3u_4)^2} & \vline & x_3 \lr{\frac{u_2}{(u_3 u_4)^2}} \pmb \phi_0^T & \vline & - \lr{\frac{u_2}{(u_3 u_4)^2}} \pmb \phi_0^T}^T\\
    \pmb \phi_3 &= \bm{x_3 \pmb \phi_0^T & \vline & x_3 u_1 \pmb \phi_0 ^T & \vline & x_3 \lr{\frac{u_2}{u_3^2 u_4^2}} \pmb \phi_0 ^T & \vline & - \lr{\frac{u_2}{u_3^2 u_4^2}} \pmb \phi_0 ^T}^T\\
    \pmb \phi_0 &= \bm{\frac{u_3}{u_4} & \frac{1}{u_4} & \frac{1}{u_3 u_4}}^T
\end{align*}


% ==============================================================================
\subsubsection{Windowed Least Squares For Parameter Estimation}

As gaseous $NH_3$ out measurements don't affect the $NO_x$ and $NH_3^{(ads)}$ process dynamics, only $NO_x$ and $NH_3^{(ads)}$ process dynamics become relevant for $x_3(t)$ and model parameter estimation. We have $NO_x$ and $NH_3^{(ads)}$ process dynamics as:

\begin{align*}
    x_1(k+1) &= u_1 - \pmb \phi_1^T \lr{x_3 \pmb \theta_1}\\
    x_3(k+1) &= x_3 - \pmb \phi_3^T \pmb \theta_3
\end{align*}

\itbf{Idea:} Assuming $x_3$ varies slowly, specifically at every $l$ samples, we can estimate it lumped with the constant parameters for a given window-length $l$ and then uses these parameters estimates to find the lumped parameters of the $NO_x$ and $NH_3^{(ads)}$ process dynamics.

The new-parameter vector for $NO_x$ dynamics is:
\begin{align*}
    \pmb \beta(k) &= x_3(k) \pmb \theta_1
\end{align*}

Multiplying $\theta_{1i}$ on both sides of the second equation:
\begin{align*}
    \theta_{1i} x_3(k+1) &= \theta_{1i} x_3 - \theta_{1i} \pmb \phi_3^T \pmb \theta_3\\
    \beta_i(k+1) &= \beta_i(k) - \bm{\beta_i \pmb \phi_0^T & \vline & \beta_i u_1 \pmb \phi_0 ^T & \vline & \beta_i \lr{\frac{u_2}{u_3^2 u_4^2}} \pmb \phi_0 ^T & \vline & - \theta_{1i}\lr{\frac{u_2}{u_3^2 u_4^2}} \pmb \phi_0 ^T}^T \theta_3\\
    %====
    \beta_i(k+1)&= \beta_i(k) - \bm{\beta_i \pmb \phi_0^T & \vline & \beta_i u_1 \pmb \phi_0 ^T & \vline & \beta_i \lr{\frac{u_2}{u_3^2 u_4^2}} \pmb \phi_0 ^T & \vline & - \lr{\frac{u_2}{u_3^2 u_4^2}} \pmb \phi_0 ^T}^T \theta_{\beta_i}\\
    \text{Where,} \qquad &\\
    \theta_{\beta_i} &= \mat{ \left [
                            n V \mu q_{od}  \right .&
                            n V \mu m_{od}  &
                            n V \mu c_{od}  &
                            n V \mu q_{scr} &
                            n V \mu m_{scr} &
                            n V \mu c_{scr} & \\ &
                            n V \mu b_u q_{ads} &
                            n V \mu b_u m_{ads} &
                            n V \mu b_u c_{ads} &
                            \theta_i \Gamma n V \mu b_u q_{ads} &
                            \theta_i \Gamma n V \mu b_u m_{ads} &
                            \left . \theta_i \Gamma n V \mu b_u c_{ads} \right]}
\end{align*}
